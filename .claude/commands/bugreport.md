---
description: Report failing tests as GitHub issues (checks for duplicates first)
allowed-tools: Bash(gh:*), Bash(dotnet test:*), Read, Grep, Glob
argument-hint: [test-filter] or run after test failures
---

# Bug Report for Failing Tests

Create comprehensive GitHub issues for failing tests, avoiding duplicates.

## Process

### 0. Verify Test Failures (if test names provided)

If the user provides test names or a test filter, **first run those specific tests** to verify the failures:

```bash
# For specific test names
dotnet test tests/Asynkron.JsEngine.Tests --filter "FullyQualifiedName~{TestName}" -v detailed 2>&1

# For Test262 tests
dotnet test tests/Asynkron.JsEngine.Tests.Test262 -c Release \
  --settings tests/Asynkron.JsEngine.Tests.Test262/LanguageTests.runsettings \
  --filter "FullyQualifiedName~{TestName}" -v detailed 2>&1
```

**IMPORTANT:** Read and analyze the test output carefully. Extract:
- The exact error message
- The stack trace showing where the failure occurred
- Any assertion details (expected vs actual values)
- The test's JavaScript code if visible

### 1. Gather Context for Each Failing Test

For each failing test:

#### a) Search for relevant source files
Use Grep to find related implementation code:
```bash
# Search for key types/methods mentioned in the stack trace
```

#### b) Check spec.md for relevant specification sections
If the test relates to a specific ECMAScript feature (e.g., generators, async/await, destructuring):
```bash
# Search spec.md for relevant sections
```
Link to line numbers in spec.md that define the expected behavior.

#### c) Find the test source
```bash
# Locate the test file to understand what it's testing
```

### 2. Check if issue already exists

```bash
gh issue list --search "bug: {TestName} in:title" --state all --json number,title,state --limit 5
```

If an issue exists (open or closed), report it and skip to the next test.

### 3. Create new issue with comprehensive details

```bash
gh issue create \
  --title "bug: {TestName}" \
  --assignee "@copilot" \
  --body "$(cat <<'EOF'
## Failing Test

**Test:** `{FullyQualifiedTestName}`
**Test File:** [{TestFileName}]({RelativePathToTestFile})

## Test Output

```
{RelevantTestOutputQuoted}
```

## Error

```
{ErrorMessage}
```

## Stack Trace

```
{StackTrace}
```

## Relevant Source Files

{ListOfRelevantSourceFilesWithLinks}
- [`{FileName}`]({RelativePath}): {BriefDescription}

## ECMAScript Specification Reference

{IfApplicable}
- [spec.md L{LineNumber}]({LinkToSpecLine}): {RelevantSpecQuote}

## Context

{WhatTheTestValidatesAndPossibleRootCause}

## Suggested Investigation

{AreasToInvestigate}

## Reproduction

```bash
dotnet test tests/Asynkron.JsEngine.Tests --filter "FullyQualifiedName~{TestName}"
```

---
*Auto-generated by /bugreport*
EOF
)"
```

### 4. Summary

Report:
- Issues created (with links)
- Issues that already existed (with links)
- Total tests processed
- Key findings from test verification
